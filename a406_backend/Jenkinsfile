pipeline {
    agent any

    environment {
        GIT_BRANCH = 'dev_back'
        GITLAB_REPO_URL = 'https://lab.ssafy.com/s12-webmobile2-sub1/S12P11A406.git'
        DOCKER_IMAGE_NAME = 'fillit'
        DOCKER_CONTAINER_NAME = 'fillit-container'
        DOCKER_PORT = '8081'
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'gitlab-credentials-id', usernameVariable: 'GITLAB_USERNAME', passwordVariable: 'GITLAB_PASSWORD')]) {
                        git branch: "${GIT_BRANCH}",
                            credentialsId: 'gitlab-credentials-id',
                            url: "${GITLAB_REPO_URL}"
                    }
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    dir('a406_backend') {
                        sh 'chmod +x ./gradlew'
                        sh """
                            ./gradlew clean build \
                            -Djwt.secret-key=${env.JWT_SECRET_KEY} \
                            -Dspring.datasource.url=${env.DB_URL} \
                            -Dspring.datasource.username=${env.DB_USERNAME} \
                            -Dspring.datasource.password=${env.DB_PASSWORD} \
                            -Dspring.mail.password=${env.MAIL_PASSWORD}
                        """
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                    docker build -t ${env.DOCKER_IMAGE_NAME}:latest -t ${env.DOCKER_IMAGE_NAME}:${env.BUILD_NUMBER} .
                    """
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    sh """
                    docker stop ${env.DOCKER_CONTAINER_NAME} || true
                    docker rm ${env.DOCKER_CONTAINER_NAME} || true
                    docker run -d -p ${env.DOCKER_PORT}:${env.DOCKER_PORT} --name ${env.DOCKER_CONTAINER_NAME} \
                        -e JWT_SECRET_KEY=${env.JWT_SECRET_KEY} \
                        -e DB_URL=${env.DB_URL} \
                        -e DB_USERNAME=${env.DB_USERNAME} \
                        -e DB_PASSWORD=${env.DB_PASSWORD} \
                        -e GOOGLE_ACCESS_TOKEN_API=${env.GOOGLE_ACCESS_TOKEN_API} \
                        -e GOOGLE_CLIENT_ID=${env.GOOGLE_CLIENT_ID} \
                        -e GOOGLE_CLIENT_SECRET=${env.GOOGLE_CLIENT_SECRET} \
                        -e GOOGLE_GET_USER_INFO_API=${env.GOOGLE_GET_USER_INFO_API} \
                        -e GOOGLE_REDIRECT_URI=${env.GOOGLE_REDIRECT_URI} \
                        -e GOOGLE_SCOPE=${env.GOOGLE_SCOPE} \
                        -e KAKAO_ACCESS_TOKEN_API=${env.KAKAO_ACCESS_TOKEN_API} \
                        -e KAKAO_CLIENT_ID=${env.KAKAO_CLIENT_ID} \
                        -e KAKAO_CLIENT_SECRET=${env.KAKAO_CLIENT_SECRET} \
                        -e KAKAO_GET_USER_INFO_API=${env.KAKAO_GET_USER_INFO_API} \
                        -e KAKAO_REDIRECT_URI=${env.KAKAO_REDIRECT_URI} \
                        -e NAVER_ACCESS_TOKEN_API=${env.NAVER_ACCESS_TOKEN_API} \
                        -e NAVER_CLIENT_ID=${env.NAVER_CLIENT_ID} \
                        -e NAVER_CLIENT_SECRET=${env.NAVER_CLIENT_SECRET} \
                        -e NAVER_GET_USER_INFO_API=${env.NAVER_GET_USER_INFO_API} \
                        -e NAVER_REDIRECT_URI=${env.NAVER_REDIRECT_URI} \
                        -e AWS_ACCESS_KEY_ID=${env.AWS_ACCESS_KEY_ID} \
                        -e AWS_REGION=${env.AWS_REGION} \
                        -e AWS_S3_BUCKET_NAME=${env.AWS_S3_BUCKET_NAME} \
                        -e AWS_SECRET_ACCESS_KEY=${env.AWS_SECRET_ACCESS_KEY} \
                        -e YOUTUBE_API_KEY=${env.YOUTUBE_API_KEY} \
                        -e YOUTUBE_API_URL=${env.YOUTUBE_API_URL} \
                        -e GEMINI_API_KEY=${env.GEMINI_API_KEY} \
                        -e EC2_SERVER_URL=${env.EC2_SERVER_URL} \
                        -e MAIL_PASSWORD=${env.MAIL_PASSWORD} \
                        ${env.DOCKER_IMAGE_NAME}:latest
                    """
                }
            }
        }
    }
}
