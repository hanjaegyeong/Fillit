pipeline {
    agent any

    environment {
        GIT_BRANCH = 'dev_back'
        GITLAB_REPO_URL = 'https://lab.ssafy.com/s12-webmobile2-sub1/S12P11A406.git'
        DOCKER_IMAGE_NAME = 'fillit'
        DOCKER_CONTAINER_NAME = 'fillit-container'
        DOCKER_PORT = '8081'
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'gitlab-credentials-id', usernameVariable: 'GITLAB_USERNAME', passwordVariable: 'GITLAB_PASSWORD')]) {
                        git branch: "${GIT_BRANCH}",
                            credentialsId: 'gitlab-credentials-id',
                            url: "${GITLAB_REPO_URL}"
                    }
                }
            }
        }

        stage('Build') {
            steps {
                dir('a406_backend') {
                    sh """
                        chmod +x ./gradlew
                        ./gradlew clean build \
                            -Djwt.secret-key=$JWT_SECRET_KEY \
                            -Dspring.datasource.url=$DB_URL \
                            -Dspring.datasource.username=$DB_USERNAME \
                            -Dspring.datasource.password=$DB_PASSWORD \
                            -Dspring.mail.password=$MAIL_PASSWORD
                    """
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                sh """
                    docker build -t ${DOCKER_IMAGE_NAME}:latest \
                                 -t ${DOCKER_IMAGE_NAME}:${BUILD_NUMBER} \
                                 -f a406_backend/Dockerfile a406_backend
                """
            }
        }

        stage('Deploy') {
            steps {
                sh """
                    docker stop ${DOCKER_CONTAINER_NAME} || true
                    docker rm ${DOCKER_CONTAINER_NAME} || true
                    docker run -d -p ${DOCKER_PORT}:8080 --name ${DOCKER_CONTAINER_NAME} \\
                        -e JWT_SECRET_KEY="$JWT_SECRET_KEY" \\
                        -e DB_URL="$DB_URL" \\
                        -e DB_USERNAME="$DB_USERNAME" \\
                        -e DB_PASSWORD="$DB_PASSWORD" \\
                        -e MAIL_PASSWORD="$MAIL_PASSWORD" \\
                        -e GOOGLE_ACCESS_TOKEN_API="$GOOGLE_ACCESS_TOKEN_API" \\
                        -e GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \\
                        -e GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \\
                        -e GOOGLE_GET_USER_INFO_API="$GOOGLE_GET_USER_INFO_API" \\
                        -e GOOGLE_REDIRECT_URI="$GOOGLE_REDIRECT_URI" \\
                        -e GOOGLE_SCOPE="$GOOGLE_SCOPE" \\
                        -e KAKAO_ACCESS_TOKEN_API="$KAKAO_ACCESS_TOKEN_API" \\
                        -e KAKAO_CLIENT_ID="$KAKAO_CLIENT_ID" \\
                        -e KAKAO_CLIENT_SECRET="$KAKAO_CLIENT_SECRET" \\
                        -e KAKAO_GET_USER_INFO_API="$KAKAO_GET_USER_INFO_API" \\
                        -e KAKAO_REDIRECT_URI="$KAKAO_REDIRECT_URI" \\
                        -e NAVER_ACCESS_TOKEN_API="$NAVER_ACCESS_TOKEN_API" \\
                        -e NAVER_CLIENT_ID="$NAVER_CLIENT_ID" \\
                        -e NAVER_CLIENT_SECRET="$NAVER_CLIENT_SECRET" \\
                        -e NAVER_GET_USER_INFO_API="$NAVER_GET_USER_INFO_API" \\
                        -e NAVER_REDIRECT_URI="$NAVER_REDIRECT_URI" \\
                        -e AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID" \\
                        -e AWS_REGION="$AWS_REGION" \\
                        -e AWS_S3_BUCKET_NAME="$AWS_S3_BUCKET_NAME" \\
                        -e AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY" \\
                        -e YOUTUBE_API_KEY="$YOUTUBE_API_KEY" \\
                        -e YOUTUBE_API_URL="$YOUTUBE_API_URL" \\
                        -e GEMINI_API_KEY="$GEMINI_API_KEY" \\
                        -e EC2_SERVER_URL="$EC2_SERVER_URL" \\
                        -e FLICKR_API_KEY="$FLICKR_API_KEY" \\
                        ${DOCKER_IMAGE_NAME}:latest
                """
            }
        }
    }
}
