pipeline {
    agent any

    environment {
        GIT_BRANCH = 'dev_back'
        GITLAB_REPO_URL = 'https://lab.ssafy.com/s12-webmobile2-sub1/S12P11A406.git'
        DOCKER_IMAGE_NAME = 'fillit'
        DOCKER_CONTAINER_NAME = 'fillit-container'
        DOCKER_PORT = '8081'
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'gitlab-credentials-id', usernameVariable: 'GITLAB_USERNAME', passwordVariable: 'GITLAB_PASSWORD')]) {
                        git branch: "${GIT_BRANCH}",
                            credentialsId: 'gitlab-credentials-id',
                            url: "${GITLAB_REPO_URL}"
                    }
                }
            }
        }

        stage('Build') {
            steps {
                dir('a406_backend') {
                    sh """
                        chmod +x ./gradlew
                        ./gradlew clean build \
                            -Djwt.secret-key="$JWT_SECRET_KEY" \\
                            -Dspring.datasource.url="$DB_URL" \\
                            -Dspring.datasource.username="$DB_USERNAME" \\
                            -Dspring.datasource.password="$DB_PASSWORD" \\
                            -Dspring.mail.password="$MAIL_PASSWORD"
                    """
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                sh """
                    docker build -t ${DOCKER_IMAGE_NAME}:latest \
                                 -t ${DOCKER_IMAGE_NAME}:${BUILD_NUMBER} \
                                 -f a406_backend/Dockerfile a406_backend
                """
            }
        }
    }
}
